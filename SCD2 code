create or replace PROCEDURE SCD2
AS
BEGIN
MERGE INTO DEST t
USING STAGING s


ON (t.ID = s.ID )
WHEN MATCHED THEN
UPDATE SET
t.ENDDATE = CASE WHEN t.ADDRESS <> s.ADDRESS THEN s.STARTDATE ELSE t.ENDDATE END,
t.IND = CASE WHEN t.ADDRESS <> s.ADDRESS THEN 0 ELSE t.IND END 


WHEN NOT MATCHED  THEN
INSERT ( ID, NAME, ADDRESS, IND, STARTDATE, ENDDATE)
VALUES (s.ID, s.NAME, s.ADDRESS, 1, SYSDATE, '12/31/2050');


MERGE INTO DEST t
USING STAGING s
ON (t.ID = s.ID AND t.ADDRESS = s.ADDRESS)
WHEN MATCHED THEN
UPDATE SET
t.IND = CASE WHEN t.ADDRESS <> s.ADDRESS THEN 0 ELSE t.IND END   

WHEN NOT MATCHED  THEN
INSERT ( ID, NAME, ADDRESS, IND, STARTDATE, ENDDATE)
VALUES (s.ID, s.NAME, s.ADDRESS, 1, SYSDATE, '12/31/2050');
END SCD2;
/
